<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Music Sync Server</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Music Sync Server</h1>

  <div class="controls">
    <!-- Folder Selection -->
    <input type="text" id="folderInput" placeholder="Enter folder path..." />
    <button id="selectFolderBtn">Select Folder</button>

    <!-- Loop Check -->
    <label>
      <input type="checkbox" id="loopCheckbox">
      Loop current track
    </label>
  </div>

  <!-- Playlist -->
  <ul id="playlist"></ul>

  <!-- Playback Buttons -->
  <div class="buttons">
    <button id="playNextBtn">Play Next</button>
    <button id="stopBtn">Stop Playback</button>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const folderInput = document.getElementById('folderInput');
    const selectFolderBtn = document.getElementById('selectFolderBtn');
    const loopCheckbox = document.getElementById('loopCheckbox');
    const playlistEl = document.getElementById('playlist');
    const playNextBtn = document.getElementById('playNextBtn');
    const stopBtn = document.getElementById('stopBtn');

    let currentIndex = -1;
    let playlist = [];

    // --- Socket Listeners ---

    // When the server sends the playlist data (including currentIndex)
    socket.on('playlistData', (data) => {
      playlist = data.playlist;
      currentIndex = data.currentIndex;

      // Re-render the playlist
      renderPlaylist();
    });

    // If an error occurs (e.g., invalid folder)
    socket.on('errorMessage', (msg) => {
      alert('Error: ' + msg);
    });

    // --- DOM Events ---

    // 1. Select Folder -> ask server to load that folder
    selectFolderBtn.addEventListener('click', () => {
      const folderPath = folderInput.value.trim();
      if (!folderPath) {
        alert('Please enter a valid folder path');
        return;
      }
      socket.emit('selectFolder', folderPath);
    });

    // 2. Play Next
    playNextBtn.addEventListener('click', () => {
      const loop = loopCheckbox.checked;
      socket.emit('playNext', loop);
    });

    // 3. Stop
    stopBtn.addEventListener('click', () => {
      socket.emit('stop');
    });

    // --- Rendering ---

    function renderPlaylist() {
      playlistEl.innerHTML = '';

      playlist.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = song;

        // Highlight if this is the current track
        if (index === currentIndex) {
          li.classList.add('current');
        }

        // Double-click to play
        li.addEventListener('dblclick', () => {
          const loop = loopCheckbox.checked;
          socket.emit('play', { index, loop });
        });

        playlistEl.appendChild(li);
      });
    }
  </script>
</body>
</html>